name: Build Raw ESC/POS Printer Helper

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Build Raw ESC/POS executables
      run: npm run build

    - name: Create setup guide
      run: |
        echo "# Cottage Tandoori Printer Helper Setup" > setup-guide.md
        echo "" >> setup-guide.md
        echo "## Installation" >> setup-guide.md
        echo "1. Download cottage-tandoori-printer.exe" >> setup-guide.md
        echo "2. Run the executable" >> setup-guide.md
        echo "3. Test with http://localhost:3001/health" >> setup-guide.md
        echo "" >> setup-guide.md
        echo "## Troubleshooting" >> setup-guide.md
        echo "- Ensure Windows firewall allows port 3001" >> setup-guide.md
        echo "- Check thermal printer is connected and powered" >> setup-guide.md
        echo "- Verify printer drivers are installed" >> setup-guide.md

    - name: Verify executables
      run: |
        if (Test-Path "cottage-tandoori-printer.exe") {
          Write-Host "✅ cottage-tandoori-printer.exe created successfully"
          $size = (Get-Item "cottage-tandoori-printer.exe").Length
          Write-Host "File size: $($size / 1MB) MB"
        } else {
          Write-Host "❌ cottage-tandoori-printer.exe not found"
          exit 1
        }
      shell: pwsh

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      if: github.ref == 'refs/heads/main'
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: "Cottage Tandoori Printer Helper v1.0.${{ github.run_number }}"
        files: |
          cottage-tandoori-printer.exe
          setup-guide.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}