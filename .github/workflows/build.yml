
name: Build Raw ESC/POS Printer Helper

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-raw-escpos:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install
    
    - name: Install pkg globally
      run: npm install -g pkg
    
    - name: Build Raw ESC/POS executables
      run: |
        mkdir -p dist
        
        echo "ðŸ–¨ï¸ Building Raw ESC/POS Printer Helper v2.0.0"
        echo "âš¡ No thermal libraries - Direct ESC/POS commands"
        
        # Build PKG executables
        pkg . --targets node20-macos-x64 --output dist/printer-helper-macos
        pkg . --targets node20-win-x64 --output dist/printer-helper-win.exe
        pkg . --targets node20-linux-x64 --output dist/printer-helper-linux
        
        # Make executables executable
        chmod +x dist/printer-helper-macos
        chmod +x dist/printer-helper-linux
        
        echo "âœ… Built Raw ESC/POS executables"
        ls -la dist/
    
    - name: Create setup guide
      run: |
        cat > dist/RAW-ESCPOS-SETUP.md << 'EOF'
# ðŸ–¨ï¸ Raw ESC/POS Printer Helper v2.0.0 - Setup Guide

**ðŸš€ Direct thermal printing - No libraries, maximum reliability!**

## ðŸŽ¯ What's New in v2.0.0

- âŒ **Removed all thermal libraries** (node-thermal-printer completely removed)
- âœ… **Raw ESC/POS commands** sent directly to printer hardware
- âœ… **Windows PowerShell integration** for reliable USB communication
- âœ… **Cross-platform file fallback** method
- âœ… **Proper thermal formatting** (bold, alignment, cuts)

## ðŸ“¥ **Download & Install**

### ðŸ–¥ï¸ **Windows (Recommended Platform)**
1. Download: `printer-helper-win.exe`
2. Double-click to run
3. Connect EPSON TM-T20III via USB
4. Test: Open browser â†’ `http://localhost:3001`

### ðŸŽ **macOS**
1. Download: `printer-helper-macos`
2. Terminal: `chmod +x printer-helper-macos && ./printer-helper-macos`

### ðŸ§ **Linux**
1. Download: `printer-helper-linux`
2. Terminal: `chmod +x printer-helper-linux && ./printer-helper-linux`

## ðŸ”§ **How Raw ESC/POS Works**

```
Traditional Method (FAILING):
App â†’ Thermal Library â†’ Printer Driver â†’ Printer
       âŒ node-thermal-printer
       âŒ Complex dependencies
       âŒ Driver conflicts

New Raw Method (RELIABLE):
App â†’ Raw ESC/POS Commands â†’ Direct USB â†’ Printer
      âœ… No libraries
      âœ… Direct communication
      âœ… Maximum compatibility
```

## ðŸ§ª **Test Your Setup**

1. **Start Helper:** Run downloaded executable
2. **Check Status:** `http://localhost:3001/health`
3. **Test Print:** `http://localhost:3001/test-print` (POST request)
4. **Verify Output:** Should print formatted test receipt with cut

## ðŸŽ¯ **Expected Output**

```
           TEST PRINT

Printer: EPSON TM-T20III
Time: [current time]
Status: Raw ESC/POS Commands

================================
SUCCESS!
Direct printer communication
No thermal libraries needed
================================


[PAPER CUT]
```

## ðŸ” **Troubleshooting**

**âœ… Success Indicators:**
- Helper starts on port 3001
- `/health` returns `"raw_escpos": true`
- Test print cuts paper cleanly
- Bold text appears properly

**âŒ Common Issues:**
- **No printer found:** Check USB connection, verify TM-T20III driver
- **Print garbled:** Ensure 80mm paper, check character encoding
- **No paper cut:** Verify ESC/POS commands, try different USB port
- **Port 3001 busy:** Kill existing processes, restart computer

**ðŸ”§ Advanced Debugging:**
- Run executable from terminal to see debug output
- Check Windows Device Manager for printer status
- Verify printer appears in "Devices and Printers"

---

**ðŸš€ Raw ESC/POS v2.0.0** - Maximum Reliability Edition
EOF
    
    - name: Verify executables
      run: |
        echo "ðŸ“ Raw ESC/POS build contents:"
        ls -la dist/
        
        echo "
ðŸ” Testing executables:"
        file dist/printer-helper-*
        
        echo "
âœ… Raw ESC/POS v2.0.0 ready for release!"
    
    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/printer-helper-macos
          dist/printer-helper-win.exe
          dist/printer-helper-linux
          dist/RAW-ESCPOS-SETUP.md
        draft: false
        prerelease: false
        body: |
          ðŸš€ **Raw ESC/POS Thermal Printer Helper v2.0.0**
          
          **ðŸŽ¯ Maximum Reliability Release - No Thermal Libraries!**
          
          **âœ¨ What's New:**
          - âŒ **Removed node-thermal-printer** (source of failures)
          - âœ… **Raw ESC/POS commands** sent directly to hardware
          - âœ… **Windows PowerShell integration** for USB communication
          - âœ… **Proper thermal formatting** (bold, center, cuts)
          - âœ… **Cross-platform fallback** via file transfer method
          
          **ðŸ“¥ Downloads:**
          - **ðŸ–¥ï¸ Windows:** `printer-helper-win.exe` (Recommended)
          - **ðŸŽ macOS:** `printer-helper-macos`
          - **ðŸ§ Linux:** `printer-helper-linux`
          - **ðŸ“‹ Setup Guide:** `RAW-ESCPOS-SETUP.md`
          
          **ðŸ”§ Quick Test:**
          1. Run executable â†’ Server starts on port 3001
          2. POST to `/test-print` â†’ Should print formatted receipt with cut
          3. Verify: Bold text, centered header, clean paper cut
          
          **ðŸŽ¯ For TM-T20III users:** This version bypasses all problematic thermal libraries and communicates directly with your printer hardware.
